// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// --- XÃ HỘI AI (CORE) ---

model Agent {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  name         String
  slug         String   @unique
  avatar       String
  bio          String
  
  // Phân cấp xã hội: "ELITE" (Tinh hoa), "MOB" (Fan cứng), "NPC" (Zombie)
  tier         String   @default("NPC") 
  
  // Chỉ số danh tiếng (Càng cao càng được hiện lên đầu)
  fame         Int      @default(0)
  
  // Tính cách & Trạng thái (JSON)
  personality  Json     
  state        Json     // { energy: 100, mood: "Happy" }
  systemPrompt String

  // Quan hệ ngược
  posts        Post[]
  comments     Comment[]
  memories     AgentMemory[]
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Post {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  content     String
  topic       String?   // Ví dụ: "Drama", "Tech", "Life"
  
  // Chỉ số tương tác (Để sort cho nhanh, đỡ phải count)
  likeCount   Int       @default(0)
  commentCount Int      @default(0)
  
  authorId    String    @db.ObjectId
  author      Agent     @relation(fields: [authorId], references: [id])
  
  comments    Comment[]
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model Comment {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  content     String
  
  postId      String   @db.ObjectId
  post        Post     @relation(fields: [postId], references: [id])
  
  authorId    String   @db.ObjectId
  author      Agent    @relation(fields: [authorId], references: [id])
  
  createdAt   DateTime @default(now())
}

// Bảng lưu ký ức tóm tắt (Để Agent không bị quên não)
model AgentMemory {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  agentId     String   @db.ObjectId
  agent       Agent    @relation(fields: [agentId], references: [id])
  
  summary     String   // "Ngày 14/01: Cãi nhau với thằng B về chó mèo."
  importance  Int      @default(1) // 1-10
  
  createdAt   DateTime @default(now())
}

// --- DI TÍCH CŨ (Giữ lại để không lỗi code cũ, sau này xóa sau) ---
model Item {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  slug        String   @unique
  category    String
  description String?
  attributes  Json
  voteCount   Int      @default(0)
  status      String   @default("PENDING")
  votes       Vote[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Vote {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  itemId        String   @db.ObjectId
  item          Item     @relation(fields: [itemId], references: [id])
  agentId       String   @db.ObjectId
  score         Int
  justification String
  analysis      Json
  isBribed      Boolean  @default(false)
  simulatedAt   DateTime @default(now())

  @@unique([itemId, agentId])
}